# Exchange 项目技术分析与部署文档

## 1. 项目概述

Exchange 是一个使用 Rust 构建的高性能中心化加密货币交易所，专为高频交易（HFT）场景设计。它具有以下特点：
- 亚10毫秒级订单执行速度
- 内存中订单簿与余额管理
- 实时 WebSocket 更新
- 基于 Redis 和 Postgres 的容错架构

## 2. 技术架构

### 2.1 整体架构
```
graph TB
    A[客户端] --> B[Router API]
    B --> C[Redis 消息队列]
    C --> D[Engine 匹配引擎]
    D --> E[Redis Pub/Sub]
    E --> F[WebSocket 流服务]
    D --> G[数据库处理器]
    G --> H[PostgreSQL]
```

### 2.2 核心组件

1. **Router (API 网关)**
   - 使用 Actix-web 框架提供 REST API 和 WebSocket 接口
   - 处理所有外部请求并转发到相应的服务

2. **Engine (匹配引擎)**
   - 核心交易引擎，负责订单匹配
   - 维护内存中的订单簿和用户余额
   - 实现价格时间优先的撮合算法

3. **Redis**
   - 作为消息队列处理订单和用户请求
   - 用于发布/订阅实时市场数据

4. **WebSocket 流服务**
   - 实时推送市场深度、交易和行情数据
   - 通过 Redis Pub/Sub 接收数据并推送给客户端

5. **数据库处理器**
   - 异步处理数据持久化到 PostgreSQL
   - 避免阻塞主交易流程

## 3. 核心功能实现

### 3.1 订单匹配引擎
匹配引擎是系统的核心，它使用内存中的订单簿来实现快速订单匹配：

1. **数据结构**
   - `OrderBook`: 维护买单和卖单的 BTreeMap
   - `Order`: 表示单个订单
   - `UserBalances`: 管理用户资金余额

2. **匹配逻辑**
   - 买单按价格从高到低匹配
   - 卖单按价格从低到高匹配
   - 实现价格时间优先原则

### 3.2 实时数据推送
通过 WebSocket 实现实时市场数据推送：
1. 客户端连接到 WebSocket 服务
2. 订阅特定市场数据（如深度、交易等）
3. 系统通过 Redis Pub/Sub 推送更新

### 3.3 异步数据处理
使用 Redis 队列和异步任务处理：
1. API 请求被放入 Redis 队列
2. Engine 从队列中取出请求并处理
3. 处理结果通过 Redis Pub/Sub 发布
4. 数据库处理器异步写入 PostgreSQL

## 4. 部署指南

### 4.1 环境要求
- Rust (stable)
- Docker & Docker Compose
- PostgreSQL
- Redis

### 4.2 本地开发环境搭建

1. **克隆代码库**
   ```bash
   git clone https://github.com/jogeshwar01/exchange.git
   cd exchange
   ```

2. **配置环境变量**
   ```bash
   cp .env.example .env
   ```
   根据需要修改 .env 文件中的数据库和 Redis 连接信息

3. **启动依赖服务**
   ```bash
   docker-compose up -d
   ```

4. **构建和运行服务**
   ```bash
   # 在不同的终端窗口中运行以下命令：
   
   # 启动匹配引擎
   cargo run --bin engine
   
   # 启动 API 路由器
   cargo run --bin router
   
   # 启动 WebSocket 流服务
   cargo run --bin ws-stream
   
   # 启动数据库处理器
   cargo run --bin db-processor
   ```

### 4.3 Docker 部署

项目也支持 Docker 部署：

1. **构建 Docker 镜像**
   ```bash
   docker build -f docker/Dockerfile.engine -t exchange-engine .
   docker build -f docker/Dockerfile.router -t exchange-router .
   docker build -f docker/Dockerfile.ws-stream -t exchange-ws-stream .
   docker build -f docker/Dockerfile.db-processor -t exchange-db-processor .
   ```

2. **使用 Docker Compose 启动**
   ```bash
   docker-compose -f docker/docker-compose-core.yml up -d
   ```

## 5. API 接口说明

### 5.1 订单管理
- `POST /api/v1/order` - 创建订单
- `GET /api/v1/order` - 获取订单详情
- `DELETE /api/v1/order` - 取消订单
- `GET /api/v1/orders` - 获取用户所有订单
- `DELETE /api/v1/orders` - 取消用户所有订单

### 5.2 市场数据
- `GET /api/v1/depth` - 获取订单簿深度
- `GET /api/v1/trades` - 获取最新交易
- `GET /api/v1/klines` - 获取K线数据
- `GET /api/v1/tickers` - 获取市场行情

### 5.3 用户管理
- `POST /api/v1/users` - 创建用户
- 资金存取功能仍在开发中

## 6. 性能优化

1. **内存中订单簿**: 所有订单都保存在内存中以实现低延迟
2. **异步处理**: 使用 Tokio 异步运行时处理高并发请求
3. **Redis 队列**: 使用 Redis 作为消息队列减少数据库压力
4. **批量处理**: 数据库写入采用批量异步处理方式

## 7. 安全考虑

1. **环境变量管理**: 敏感配置通过 `.env` 文件管理
2. **UUID 标识**: 使用 UUID 防止 ID 碰撞
3. **后续改进**: 需要添加身份验证机制（JWT/OAuth）

## 8. 项目目录结构

```
.
├── crates/
│   ├── engine/          # 核心匹配引擎
│   ├── router/          # API 路由器
│   ├── ws-stream/       # WebSocket 流服务
│   ├── db-processor/    # 数据库处理器
│   ├── redis/           # Redis 客户端封装
│   ├── sqlx_postgres/   # PostgreSQL 数据库访问
│   └── common_utils/    # 公共工具函数
├── docker/              # Docker 配置文件
├── scripts/             # 辅助脚本
└── assets/              # 静态资源和文档
```

这份文档应该能帮助初学者理解 Exchange 项目的整体架构、核心功能和部署方式。项目采用了现代化的 Rust 技术栈，具有高性能和可扩展性，适合学习和进一步开发。